---
title: "PE 분석"
categories: 
  - 해킹
  - 리버싱
  - 프로그래밍

last_modified_at: 2019-02-04T00:00:00+09:00
toc: true
toc_label: "목차" # toc 이름 정의
toc_icon: "cog" #font Awesome아이콘으로 toc 아이콘 설정
toc_sticky: true # 스크롤 내릴때 같이 내려가는 목차
---

# PE 분석

VA (Virtual Address) 프로세스 가상 메모리의 절대 주소

RVA(relative virtual Address) : 어느 기준 위치(Imagebase)에서부터의 상대주소

RVA + ImageBase = VA



PE 헤더 내의 정보는 RVA 형태로 된 것이 많다. (Pe파일 이 프로세스 가상 메모리의 특정 위치에 로딩되는 수난 이미 그 위치에 다른 PE 파일이 로딩되어 있을 수 있다. 그럴 때 재배치 과정을 통해 다른 위치에 로딩 되어야 하기 때문)



## IMAGE_DOS_HEADER

PE 파일 제일 앞쪽에 존재함.

```c++
typedef struct _IMAGE_DOS_HEADER { // DOS .EXE header
    WORD e_magic;   // Magic number 일반적인 Signature
    WORD e_cblp;    // Bytes on last page of file
    WORD e_cp;  // Pages in file
    WORD e_crlc;    // Relocations
    WORD e_cparhdr; // Size of header in paragraphs
    WORD e_minalloc;// Minimum extra paragraphs needed
    WORD e_maxalloc;// Maximum extra paragraphs needed
    WORD e_ss;  // Initial (relative) SS value
    WORD e_sp;  // Initial SP value
    WORD e_csum;    // Checksum
    WORD e_ip;  // Initial IP value
    WORD e_cs;  // Initial (relative) CS value
    WORD e_lfarlc;  // File address of relocation table
    WORD e_ovno;    // Overlay number
    WORD e_res[4];  // Reserved words
    WORD e_oemid;   // OEM identifier (for e_oeminfo)
    WORD e_oeminfo; // OEM information; e_oemid specific
    WORD e_res2[10];// Reserved words
    LONG e_lfanew;  // File address of new exe header (NT헤더의 시작 위치)
} IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;
```



### e_magic

DOS signature (4D5A => ASCII "MZ")

### e_lfanew

NT header의 옵셋을 표시(파일에 따라 가변적인 값을 가짐)

e_lfanew 가 가르키는 위치에 NT header 구조체가 존재해야합니다. (IMAGE_NT_HEADERS 구조체)



## DOS Stub

DOS Header 밑에는 DOS Stub 이 존재, 존재 여부는 옵션이며, 크기도 일정하지 않습니다. 코드와 데이터의 혼합으로 이루어져있다. 16비트 어셈블리 명령어



## NT Header

```c
typedef struct _IMAGE_NT_HEADERS {
  DWORD                 Signature ( 50450000h, "PE"00);
  IMAGE_FILE_HEADER     FileHeader;
  IMAGE_OPTIONAL_HEADER OptionalHeader;
} IMAGE_NT_HEADERS, *PIMAGE_NT_HEADERS;
```

3개의 멤버로 되어있으며, 제일 첫 멤버는 Signature로, 50450000h ("PE"00) 값을 가집니다. 그리고 Fileheader와 Optical Header 구조체 멤버가 있습니다.



## NT Header - File Header

```c
typedef struct _IMAGE_FILE_HEADER {
  WORD  Machine;
  WORD  NumberOfSections;
  DWORD TimeDateStamp;
  DWORD PointerToSymbolTable;
  DWORD NumberOfSymbols;
  WORD  SizeOfOptionalHeader;
  WORD  Characteristics;
} IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER;
```



### Machine

| Value                                    | Meaning       |
| ---------------------------------------- | ------------- |
| **IMAGE_FILE_MACHINE_I386**<br />0x014c  | x86           |
| **IMAGE_FILE_MACHINE_IA64**<br />0x0200  | Intel Itanium |
| **IMAGE_FILE_MACHINE_AMD64**<br />0x8664 | x64           |

### NumberOfSections

코드, 데이터, 리소스 등 섹션의 총 개수

반드시0보다 커야함. 정의된 섹션 개수와 실제 섹션이 다르면 에러 발생.



### SizeOfOptionalHeader

IMAGE_NT_HEADERS 구조체의 마지막 멤버는 IMAGE_OPTIONAL_HEADER32 구조체입니다.

SizeOfOptionalHeader은 이 구조체의 크기를 나타냅니다.

> IMAGE_DOS_HEADER의 e_lfanew 멤버와 IMAGE_FILE_HEADEr의 SizeOfOptionalHeader 멤버 때문에, 꽈배기 PE 파일을 만들 수 있다고 한다.



### Characteristics

파일의 속성을 나타내는 값, 실행이 가능한 형태인지 혹은 DLL 파일인지 등의 정보들이 bit OR 형식으로 조합됩니다.

0002h 와 2000h 값을 기억해 두자.

```c
#define IMAGE_FILE_RELOCS_STRIPPED           0x0001  // Relocation info stripped from file.
#define IMAGE_FILE_EXECUTABLE_IMAGE          0x0002  // File is executable 
                                                     // (i.e. no unresolved externel references).
#define IMAGE_FILE_LINE_NUMS_STRIPPED        0x0004  // Line nunbers stripped from file.
#define IMAGE_FILE_LOCAL_SYMS_STRIPPED       0x0008  // Local symbols stripped from file.
#define IMAGE_FILE_AGGRESIVE_WS_TRIM         0x0010  // Agressively trim working set



#define IMAGE_FILE_LARGE_ADDRESS_AWARE       0x0020  // App can handle >2gb addresses




#define IMAGE_FILE_BYTES_REVERSED_LO         0x0080  // Bytes of machine word are reversed.
#define IMAGE_FILE_32BIT_MACHINE             0x0100  // 32 bit word machine.
#define IMAGE_FILE_DEBUG_STRIPPED            0x0200  // Debugging info stripped from
                                                     // file in .DBG file
#define IMAGE_FILE_REMOVABLE_RUN_FROM_SWAP   0x0400  // If Image is on removable media, 
                                                     // copy and run from the swap file.
#define IMAGE_FILE_NET_RUN_FROM_SWAP         0x0800  // If Image is on Net,
                                                     // copy and run from the swap file.
#define IMAGE_FILE_SYSTEM                    0x1000  // System File.



#define IMAGE_FILE_DLL                       0x2000  // File is a DLL.



#define IMAGE_FILE_UP_SYSTEM_ONLY            0x4000  // File should only be run on a UP machine
#define IMAGE_FILE_BYTES_REVERSED_HI         0x8000  // Bytes of machine word are reversed.
```



## NT Header - Optional header

```c
typedef struct _IMAGE_DATA_DIRECTORY {
  DWORD VirtualAddress;
  DWORD Size;
} IMAGE_DATA_DIRECTORY, *PIMAGE_DATA_DIRECTORY;

#define IMAGE_NUMBEROF_DIRECTORY_ENTRIES	16


typedef struct _IMAGE_OPTIONAL_HEADER {
  WORD                 Magic; // 32Bit : 10B, 64Bit : 20B
  BYTE                 MajorLinkerVersion;
  BYTE                 MinorLinkerVersion;
  DWORD                SizeOfCode;
  DWORD                SizeOfInitializedData;
  DWORD                SizeOfUninitializedData;
  DWORD                AddressOfEntryPoint;
  DWORD                BaseOfCode;
  DWORD                BaseOfData;
  DWORD                ImageBase;
  DWORD                SectionAlignment;
  DWORD                FileAlignment;
  WORD                 MajorOperatingSystemVersion;
  WORD                 MinorOperatingSystemVersion;
  WORD                 MajorImageVersion;
  WORD                 MinorImageVersion;
  WORD                 MajorSubsystemVersion;
  WORD                 MinorSubsystemVersion;
  DWORD                Win32VersionValue;
  DWORD                SizeOfImage;
  DWORD                SizeOfHeaders;
  DWORD                CheckSum;
  WORD                 Subsystem;
  WORD                 DllCharacteristics;
  DWORD                SizeOfStackReserve;
  DWORD                SizeOfStackCommit;
  DWORD                SizeOfHeapReserve;
  DWORD                SizeOfHeapCommit;
  DWORD                LoaderFlags;
  DWORD                NumberOfRvaAndSizes;
  IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];
} IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32;

```















